# Диагностическая инструментация Spring Boot с помощью Java Flight Recorder

<!-- TOC -->
* [Диагностическая инструментация Spring Boot с помощью Java Flight Recorder](#диагностическая-инструментация-spring-boot-с-помощью-java-flight-recorder)
  * [Цель проекта](#цель-проекта)
  * [Задачи проекта](#задачи-проекта)
  * [Способы инструментации приложения](#способы-инструментации-приложения)
    * [1. Bean Post Processor](#1-bean-post-processor)
    * [2. Аспекты (AspectJ)](#2-аспекты-aspectj)
    * [3. Инструментация байт-кода](#3-инструментация-байт-кода)
  * [Решаемые задачи](#решаемые-задачи)
    * [Анализ Spring Beans](#анализ-spring-beans)
    * [Трейсинг вызовов](#трейсинг-вызовов)
  * [Плюсы и минусы разных подходов](#плюсы-и-минусы-разных-подходов)
  * [Запуск с Java Flight Recorder](#запуск-с-java-flight-recorder)
  * [Параметры](#параметры)
<!-- TOC -->

## Цель проекта

Цель проекта — разработать библиотеку для Spring, которая использует Java Flight Recorder (JFR) для мониторинга и
трассировки ключевых процессов Spring Framework, включая:

- Инициализацию контекста;
- Создание бинов;
- Обработку входящих HTTP-запросов;
- Вызовы Spring Rest и Spring Data;
- Использование пулов потоков и планировщиков задач.

## Задачи проекта

1. **Исследование возможностей JFR и Spring**:
    - Изучение возможностей JFR для создания пользовательских событий.
    - Определение точек в жизненном цикле Spring для инструментации (Bean Lifecycle, RestControllers, Data
      Repositories).

2. **Разработка архитектуры интеграции JFR со Spring**:
    - Определение точек интеграции для трассировки (BeanPostProcessor, фильтры HTTP-запросов, Thread Pools).
    - Разработка типов событий для мониторинга процессов Spring.

3. **Рассмотрение подходов к генерации событий JFR**:
    - **Bean Post Processor**: инструментирование жизненного цикла бинов.
    - **AspectJ (AOP)**: мониторинг вызовов методов.
    - **Инструментация байт-кода**: внедрение кода при загрузке классов.

4. **Инструментация Spring-пулов потоков и планировщиков**:
    - Мониторинг использования потоков (`ThreadPoolTaskExecutor`, `ScheduledExecutorService`).
    - Отслеживание выполнения запланированных задач с использованием аннотаций (`@Scheduled`).

5. **Создание пользовательских JFR-событий**:
    - Создание событий для трассировки времени инициализации бинов, обработки HTTP-запросов и выполнения задач.

6. **Разработка Spring Boot Starter для JFR-инструментации**:
    - Автоматическая настройка и подключение зависимости на этапе старта приложения.

7. **Тестирование и оптимизация**:
    - Нагрузочное тестирование для оценки влияния инструментирования на производительность.
    - Оптимизация с целью минимизации накладных расходов.

## Способы инструментации приложения

### 1. Bean Post Processor

Позволяет отслеживать создание и уничтожение Spring Bean-ов.

- **Плюсы**:
    - Легкость интеграции через стандартные механизмы Spring.
    - Отслеживание жизненного цикла бинов.

- **Минусы**:
    - Ограничен только бинами, не отслеживает методы или другие аспекты приложения.

### 2. Аспекты (AspectJ)

AOP позволяет добавлять логику к любому методу в приложении.

- **Плюсы**:
    - Гибкость и возможность мониторинга методов контроллеров и репозиториев.
    - Конфигурация аспектов с возможностью динамического отключения.

- **Минусы**:
    - Потенциальные накладные расходы при выполнении аспектов.
    - Возможное снижение производительности из-за влияния на JIT-компиляцию.

### 3. Инструментация байт-кода

Позволяет глубоко контролировать работу приложения на уровне загрузки классов.

- **Плюсы**:
    - Глубокий контроль за выполнением методов и асинхронных вызовов.
    - Возможность трассировки без изменения исходного кода.

- **Минусы**:
    - Сложность реализации и тестирования.
    - Возможность ошибок при взаимодействии с другими библиотеками.

## Решаемые задачи

### Анализ Spring Beans

Сбор данных о времени создания Spring Bean-ов и их зависимостях для анализа причин долгой инициализации и рекурсивных
зависимостей.

| Событие                        | Источник данных          |
|--------------------------------|--------------------------|
| Регистрация Bean Definition-а  | spring, aspect, bytecode |
| Начало инициализации bean-а    | spring, aspect, bytecode |
| Окончание инициализации bean-а | spring, aspect, bytecode |

### Трейсинг вызовов

Использование JFR для отслеживания вызовов методов с возможностью динамического включения и низким влиянием на
производительность.

| Событие                      | Источник данных  |
|------------------------------|------------------|
| Начало выполнения запроса    | aspect, bytecode |
| Окончание выполнения запроса | aspect, bytecode |
| Вызов сервиса                | aspect, bytecode |
| Вызов репозитория            | aspect, bytecode |

## Плюсы и минусы разных подходов

| Метод                        | Плюсы                                                 | Минусы                                                                         |
|------------------------------|-------------------------------------------------------|--------------------------------------------------------------------------------|
| **Bean Post Processor**      | Легкость интеграции, поддержка жизненного цикла бинов | Ограниченный охват (только бины), отсутствие трассировки вызовов методов       |
| **AspectJ (AOP)**            | Гибкость, возможность инструментировать любые методы  | Накладные расходы на аспекты, снижение производительности в критических местах |
| **Инструментация байт-кода** | Глубокая интеграция, высокая детализация событий      | Сложность реализации, повышенная вероятность ошибок, сложность тестирования    |

## Запуск с Java Flight Recorder

Для запуска приложения с инструментированием через JFR добавьте опции VM:

```shell
-XX:+FlightRecorder -XX:StartFlightRecording=filename=recording.jfr
```

## Параметры

| Код                                                   | Значение по умолчанию | Описание                                                       |
|-------------------------------------------------------|-----------------------|----------------------------------------------------------------|
| `spring.jfr.instrumentation.beans-creation.enabled`   | `false`               | Переключатель инструментирования создания бинов                |
| `spring.jfr.instrumentation.bean-definitions.enabled` | `false`               | Переключатель инструментирования определений бинов             |
| `spring.jfr.instrumentation.jpa-repository.enabled`   | `false`               | Переключатель инструментирования вызовов JPA репозиториев      |
| `spring.jfr.instrumentation.controller.enabled`       | `false`               | Переключатель инструментирования вызовов контроллеров          |
| `spring.jfr.instrumentation.rest-controller.enabled`  | `false`               | Переключатель инструментирования вызовов Rest контроллеров     |
| `spring.jfr.instrumentation.scheduler.enabled`        | `false`               | Переключатель инструментирования вызовов запланированных задач |
| `spring.jfr.instrumentation.async.enabled`            | `false`               | Переключатель инструментирования вызовов асинхронных методов   |
| `spring.jfr.instrumentation.component.enabled`        | `false`               | Переключатель инструментирования вызовов методов компонент     |
| `spring.jfr.instrumentation.service.enabled`          | `false`               | Переключатель инструментирования вызовов методов сервисов      |
